<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Grag</title>
<script src="/jslib/jquery-2.1.3.js"></script>
<script src="/jslib/jquery-ui.js"></script>
<link rel="stylesheet" href="/jslib/jquery-ui.css">
<script src="/socket.io/socket.io.js"></script>
<script src="/jslib/jquery.toast.min.js"></script> <!-- source: https://github.com/kamranahmedse/jquery-toast-plugin -->  
<script src="https://unpkg.com/smoothscroll-polyfill@0.4.4/dist/smoothscroll.min.js"></script> <!-- source: https://github.com/iamdustan/smoothscroll -->
<link rel="stylesheet" href="/jslib/jquery.toast.min.css">
<link rel="stylesheet" href="grag3-tail.css">
<style>


</style>

<script>

var socket = io.connect('/browser')
var clientId = undefined
var things = {}

var groupDef = {
    'main': {
        name: 'Main',
        style: 'bg-cogs',
    },
    'hoard': {
        name: 'Hoard',
        style: 'bg-cogs',
    },
    'food': {
        name: 'KÃ¼che',
        style: 'bg-cogs',
    },
    'bad': {
        name: 'Bad',
        style: 'bg-cogs',
    },
    'flur': {
        name: 'Flur',
        style: 'bg-cogs',
    },
    'halle': {
        name: 'Halle',
        style: 'bg-cogs',
    },
    'outdoor': {
        name: 'Outdoor',
        style: 'bg-cogs',
    },
    'misc': {
        name: 'Misc',
        style: 'bg-circuit',
    }
}

function createGroups() {
    Object.keys(groupDef).forEach(id => groupDef[id].id = id)
    let body = $('body')
    Object.values(groupDef).forEach(def => {
        let box = '<div class="m-4 rounded-xl shadow-2xl border-4 border-solid border-slate-700 space-x-4' + def.style + '"> \
        <div class="text-2xl font-bold pl-3 pt-2">' + def.name + '</div> \
    <div id="group-' + def.id + '" class="flex flex-row flex-wrap object-left content-start"></div> \
</div>'
        body.append(box)
    })
}

function createThingCb(thing) {
    if (thing.def.render === false) return
    console.log('Creating thing ' + thing.def.name + ' (' + thing.id + ') in group ' + thing.def.group)
    let group = $('#group-' + thing.def.group)
    if (!group[0]) {
        alert('thing ' + thing.id + ' group unknown: ' + thing.def.group)
        return
    }
    // class="m-4 mx-4 p-4 max-w-sm mx-auto rounded-xl shadow-lg flex space-x-4 bg-lime-50"
    let box = '<div id="thing-fence-' + thing.id + '" class="mb-4 px-4 p-0 max-w-sm mx-0"><div id="thing-' + thing.id + '" class="p-4 max-w-sm rounded-xl shadow-lg space-x-4 flex bg-lime-50" onClick="onThingClicked(\'' + thing.id + '\')">Loading...</div></div>'
    group.append(box)
    things[thing.id].onChanged = createOnThingChanged(box)
    things[thing.id].onChanged(thing)
}

function onThingClicked(thingId) {
    let thing = things[thingId]
    if (!thing) return
    socket.emit('things', { id: thing.id, action: 'TOGGLE' } )
}

function createOnThingChanged(box) {
    return (thing, diff) => {
        let obj = $('#thing-' + thing.id)
        if (!obj) return
        console.log('Thing ' + thing.id + ' changed', diff)
        let value = thing.value
        let bgClass = ''
        switch (thing.status) {
            case 'uninitialized':
                bgClass = 'bg-stone-50'
                value = 'loading...'
                break
            case 'alive':
            case 'stale':
            case 'ignored':
                bgClass = thing.value == 'ON' ? 'bg-amber-200' : 'bg-lime-50'
                break;
            case 'dead':
                bgClass = 'bg-stone-300'
                value = 'unreachable'
                break
            default:
                bgClass = 'bg-red-400'
                value = 'error'
        }
        obj.removeClass('bg-stone-50 bg-lime-50 bg-amber-200 bg-stone-300 bg-red-400') // TODO auto-select 'bg-*' and don't remove what we want to set new
        obj.addClass(bgClass)
        let imgsrc = thing.value == 'ON' ? 'fa/lightbulb-on.svg' : 'fa/lightbulb.svg'
        if (thing.def.render instanceof Object) {
            if (thing.value == 'ON' && thing.def.render['icon-on']) imgsrc = thing.def.render['icon-on']
            else if (thing.value == 'OFF' && thing.def.render['icon-off']) imgsrc = thing.def.render['icon-off']
            else if (thing.def.render['icon']) imgsrc = thing.def.render['icon']
        }
        obj[0].innerHTML = '<div class="shrink-0"><img class="h-12 w-20" src="img-grag/' + imgsrc + '" alt="Logo"></div>' +
            '<div><div class="text-xl font-medium text-black">' + thing.def.name + '</div><p class="text-slate-500">' + value + '</p></div>'
    }
}

function onload() {
    createGroups()
    socket.emit('things', 'retrieveAll')
    socket.emit('subscribe', 'things')
}

</script>

<script src="smart.js"></script>

</head>
<body onload="onload()" class="bg-topography">

<div class="p-6 max-w-sm mx-auto bg-lime-50 rounded-xl shadow-lg flex my-6 justify-center text-xl font-medium text-black">Grag zu Diensten</div>



</body></html>
